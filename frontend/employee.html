<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>หน้าพนักงาน</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            text-align: center;
        }
        button {
            width: 100%;
            max-width: 300px;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .container {
            max-width: 400px;
            margin: auto;
        }
        p {
            color: red;
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- เพิ่มส่วนนี้สำหรับแสดงชื่อพนักงาน -->
        <div style="position: absolute; top: 20px; right: 20px;">
            <span id="employeeName" style="font-weight: bold;"></span>
        </div>
        
        <h2>บันทึกการลงเวลา</h2>
        <button onclick="checkIn()">เข้างาน</button>
        <button onclick="checkOut()">ออกงาน</button>
        <p id="attendanceMessage"></p>
        
        <h2>การลางาน</h2>
        <button onclick="goToLeavePage()">ไปยังหน้าการลางาน</button>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <script>
    // ฟังก์ชันดึงข้อมูลชื่อพนักงานจาก Token และแสดงในมุมขวาบน
// ฟังก์ชันดึงข้อมูลชื่อพนักงานจาก Token และแสดงในมุมขวาบน
// ฟังก์ชันดึงข้อมูลชื่อผู้ใช้จาก Token และแสดงในมุมขวาบน
function displayEmployeeName() {
    const token = localStorage.getItem('token');
    if (token) {
        const decodedToken = jwt_decode(token);
        console.log(decodedToken);  // ดูข้อมูลทั้งหมดใน token
        const employeeName = decodedToken.username; // ใช้ username แทน fullname
        if (employeeName) {
            document.getElementById('employeeName').textContent = `ยินดีต้อนรับ, ${employeeName}`;
        } else {
            document.getElementById('employeeName').textContent = `ไม่พบข้อมูลชื่อพนักงาน`;
        }
    } else {
        document.getElementById('employeeName').textContent = `ไม่ได้ล็อกอิน`;
    }
}

// เรียกใช้ฟังก์ชันเพื่อแสดงชื่อผู้ใช้เมื่อหน้าโหลด
window.onload = displayEmployeeName;



    // เรียกใช้ฟังก์ชันเพื่อแสดงชื่อพนักงานเมื่อหน้าโหลด
    window.onload = displayEmployeeName;
    
    // ฟังก์ชันแปลงเวลาจาก ISO เป็น MySQL DATETIME format 'YYYY-MM-DD HH:MM:SS'
    function formatToMysqlDatetime(date) {
        const localDate = new Date(date.toLocaleString('en-US', { timeZone: 'Asia/Bangkok' }));
        return localDate.toISOString().slice(0, 19).replace('T', ' ');
    }
    
    // ฟังก์ชันสำหรับบันทึกเวลาเข้างาน
    async function checkIn() {
        const userId = jwt_decode(localStorage.getItem('token')).userId;
        const checkInTime = formatToMysqlDatetime(new Date());
    
        try {
            const response = await fetch('http://localhost:8000/attendance', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({ user_id: userId, check_in: checkInTime })
            });
            const result = await response.json();
            if (response.ok) {
                document.getElementById('attendanceMessage').textContent = `คุณมาเข้างานเวลา ${new Date(checkInTime).toLocaleString()}`;
            } else {
                document.getElementById('attendanceMessage').textContent = result.message;
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('attendanceMessage').textContent = 'เกิดข้อผิดพลาดในการบันทึกเวลา';
        }
    }
    
    // ฟังก์ชันสำหรับบันทึกเวลาออกงาน
    async function checkOut() {
        const userId = jwt_decode(localStorage.getItem('token')).userId;
        const checkOutTime = formatToMysqlDatetime(new Date());
    
        try {
            const response = await fetch('http://localhost:8000/attendance', {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({ user_id: userId, check_out: checkOutTime })
            });
            const result = await response.json();
            if (response.ok) {
                document.getElementById('attendanceMessage').textContent = `คุณออกงานเวลา ${new Date(checkOutTime).toLocaleString()}`;
            } else {
                document.getElementById('attendanceMessage').textContent = result.message;
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('attendanceMessage').textContent = 'เกิดข้อผิดพลาดในการบันทึกเวลา';
        }
    }
    
    // ไปยังหน้าการลางาน
    function goToLeavePage() {
        window.location.href = 'leave.html';
    }
    </script>
    
    </body>
    </html>
    